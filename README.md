# icloud_get_helper

### Service: Code sale(note:2022 years Development). Price: $500 (USD). Deliverable: Source code only. Please note that this price does not include any future revisions, maintenance, or feature additions.

## Project Overview 项目简介
This repository hosts a jailbreak-oriented research toolkit that drives Apple private frameworks to inspect and replay several iCloud workflows (token bootstrap, CloudKit backup/Photos/CloudDocs harvesting, CardDAV contacts sync, SecureBackup/escrow recovery). It ships with a command-line harness, a substrate-injectable dylib, protobuf schemas, third-party dependencies, Frida helpers, and captured HTTP sessions so you can reproduce the original device behaviour offline.  
icloud_get_helper 是一套面向越狱 iOS 设备的 iCloud 协议研究工具链，围绕 Apple 的私有 Framework（AuthKit、CloudKitDaemon、ProtectedCloudStorage、SecureBackup、Octagon 等）实现了令牌采集、CloudKit/PCS 抓包重放、通讯录和备份拉取等能力。仓库不仅包含可执行程序与 MobileSubstrate 插件，还打包了用于解析 CloudKit Protobuf 的 `.proto` 定义、第三方库、Frida 脚本以及网络抓包样本，方便在实验环境下重现苹果端到端同步流程。

## Features 功能特性
- **Cloud data pipeline / iCloud 数据管线** – The `iCloudGet` flow (implemented in `src/icloud_get/icloud_get_helper_dylib.mm`) reconstructs the CloudKit request ladder—`CONFIGURATIONS_INIT → CK_APP_INIT → zone & record fetch → asset token/content assembly`—to enumerate metadata, Photos assets, and backup manifests while reusing locally stored Apple ID headers.  
  `src/icloud_get/icloud_get_helper_dylib.mm` 通过 `iCloudGet` 串联 `CONFIGURATIONS_INIT → CK_APP_INIT → zone & record fetch → asset token/内容拼装`，批量导出 CloudDocs 元数据、iCloud Photos 以及 iOS 备份快照，所有请求都使用本地保存的 Apple ID 签名头。
- **Contacts sync / 通讯录同步** – CardDAV helpers craft the same HTTP signatures as iOS dataaccessd to dump vCards from `FindCloudContacts()`.  
  `FindCloudContacts()` 基于 CardDAV `PROPFIND/REPORT` 重建联系人存储，并输出服务器返回的 multi-status XML。
- **Device enroll & SecureBackup / SecureBackup 与设备登记** – Escrow and PCS utilities in `new_device_enroll.mm` replay the “new device” handshake (EscrowProxy `GETCLUB`, `SBDEnvironMent-v2/ENROLL`) so you can generate metadata, retrieve the Keybag, or register devices for research.  
  `new_device_enroll.mm` 实现 EscrowProxy `GETCLUB`、`SBDEnvironMent-v2/ENROLL` 请求以及 metadata 生成逻辑，配合 PCS/AKS API 可尝试注册新设备或获取 Keybag。
- **Apple account automation / Apple 账号自动化** – AuthKit entry points (`AAUISignInFlowController`, `AKAppleIDAuthenticationController`, etc.) allow scripted sign-in/out within trusted contexts like `akd/accountsd`.  
  `apple_account.mm` 调用 `AAUISignInFlowController`、`AKAppleIDAuthenticationController` 等类来模拟系统登录、刷新凭证。
- **Instrumentation assets / 调试资产** – Frida scripts (`frida/*.js`), captured sessions (`net/*.chls`), and helpers like `txt/demo.py` accelerate reverse engineering and data retrieval.  
  `frida/*.js` 提供扫描 `akd/cloudd/backupd` 的脚本，`net/*.chls` 为 Charles session，`txt/demo.py` 演示如何以签名 URL 取回 chunk。

## Repository Layout 目录结构
```
.
├── Makefile                     # Build script that compiles binaries and pushes them to jailbroken devices / 构建脚本，生成二进制并推送到越狱设备
├── bin/                         # Build artifacts (icloud_get_helper executable, dylib, etc.) / build 产物（icloud_get_helper 可执行程序、dylib 等）
├── src/
│   ├── icloud_get/              # Core Objective-C++ sources for CloudKit/PCS/CardDAV/AppleAccount / 主要 Objective-C++ 源码（CloudKit/PCS/卡达夫/AppleAccount）
│   ├── proto_code/              # CloudKit/ChunkServer/iCloud proto definitions / CloudKit/ChunkServer/iCloud proto 定义
│   ├── proto_objc/              # Objective-C files generated by protoc / 由 protoc 生成的 Objective-C 类
│   ├── third_party/             # External deps such as OpenSSL, ProtocolBuffers, Security-59754 / OpenSSL、ProtocolBuffers、Security-59754 等外部依赖
│   └── PrivateFrameworks/       # Device-extracted private framework stubs used for local linking / 本地链接用的私有 framework stub（需自行从设备提取）
├── frida/                       # Frida hook scripts / Frida Hook 脚本
├── net/                         # Charles/packet captures / Charles/Packet 捕获
├── txt/                         # MobileSubstrate plist, sample scripts, placeholder README / MobileSubstrate plist、示例脚本、占位 README
└── idb/                         # IDA databases and reverse-engineering notes / IDA 数据库/逆向资料
```

Key files 关键文件说明：
- `src/icloud_get/icloud_get_helper.mm` – The CLI hosts standalone experiments around SecureBackup/Octagon/SOS/AuthKit so you can run them directly on-device and watch the logs.  
  `src/icloud_get/icloud_get_helper.mm` 是实验型 CLI，集中了一系列 SecureBackup、Octagon、SOS、AuthKit 的调用示例，可直接在设备上运行观察日志。
- `src/icloud_get/icloud_get_helper_dylib.mm` – This dylib exports core C interfaces (`iCloudGet`, `BACKUP_ID_LIST`, `GetAvailableBackupLabel`, `PCSIdentitySetup`, etc.) for Substrate/Frida injection.  
  `src/icloud_get/icloud_get_helper_dylib.mm` 导出核心 C 接口，可通过 Substrate/Frida 注入以批量拉取数据。
- `src/icloud_get/icloud_contacts.mm` – CardDAV helper implementation backing `FindCloudContacts`.  
  `src/icloud_get/icloud_contacts.mm` 提供 `FindCloudContacts` 所需的 CardDAV helper。
- `src/icloud_get/new_device_enroll.mm` – EscrowProxy/PCS interaction helpers that assemble metadata for enroll flows.  
  `src/icloud_get/new_device_enroll.mm` 负责 EscrowProxy/PCS 交互与 metadata 生成。
- `txt/icloud_get_helper.plist` – Substrate filter configuration that targets the `akd` process by default.  
  `txt/icloud_get_helper.plist` 是 Substrate 过滤配置，默认仅注入 `akd`。
- `frida/akd.js` and siblings – Frida scripts leveraging `ApiResolver` to focus on AuthKit/CloudKit call stacks.  
  `frida/akd.js` 等脚本利用 `ApiResolver` 聚焦 AuthKit/CloudKit 函数回溯。

## Requirements 环境要求
- macOS with the latest Xcode + Command Line Tools so `xcrun -sdk iphoneos` exposes the needed SDK/headers.  
  macOS 搭配最新 Xcode + Command Line Tools，提供 `xcrun -sdk iphoneos` 所需 SDK/headers。
- Install `protoc` (Makefile points to `/usr/local/bin/protoc`) and the Objective-C plugin.  
  安装 `protoc`（Makefile 默认指向 `/usr/local/bin/protoc`）以及 Objective-C 插件。
- Extract the private frameworks/headers into `src/PrivateFrameworks/`, or symlink them to an unpacked SDK on the build host.  
  已提取的私有 Framework/headers 需放到 `src/PrivateFrameworks/`，或在构建机上符号链接到已解包的 SDK。
- Ensure `ldid2`, `sshpass`, `strip`, and related tools sit in your `PATH`.  
  `ldid2`、`sshpass`、`strip` 等工具需在 `PATH` 内。
- Keep a jailbroken iOS device ready and configure `IPHONE_HOST / IPHONE_PORT / IPHONE_PASS` in the `Makefile` (defaults to 127.0.0.1:2222 / alpine for USB forwarding).  
  一台越狱 iOS 设备，并在 `Makefile` 中配置 `IPHONE_HOST / IPHONE_PORT / IPHONE_PASS`（默认 127.0.0.1:2222 / alpine，适配 USB 端口转发）。
- Python 3 and the Frida CLI are required when running `txt/demo.py` or instrumenting processes.  
  运行 `txt/demo.py` 或使用 Frida 时需要 Python 3 与 Frida CLI。

## Build & Deploy 构建与部署
1. Customize the `IPHONE_*` values, entitlement files (`akd.xml`, `ent.xml`, etc.), and Apple Development certificate names at the top of the `Makefile` to match your target device.  
   根据目标设备替换 `Makefile` 顶部的 `IPHONE_*`、证书/entitlements（`akd.xml`、`ent.xml` 等）以及 Apple Development 证书名字。
2. Ensure the `.proto` definitions are valid and refresh `src/proto_code/*.proto` whenever Apple updates CloudKit.  
   确保 `.proto` 定义没有语法错误，并在需要时更新 `src/proto_code/*.proto`。
3. Run the following command to build and deploy:
   运行下列命令以构建并部署：
   ```sh
   make
   ```
   This command will:
   该命令会：
   - Invoke `protoc` to generate `src/proto_objc/*.m`.  
     调用 `protoc` 生成 `src/proto_objc/*.m`。
   - Use `xcrun -sdk iphoneos gcc` to build `bin/icloud_get_helper` (CLI) and `bin/icloud_get_helper.dylib`.  
     使用 `xcrun -sdk iphoneos gcc` 先构建 `bin/icloud_get_helper`（CLI），再构建 `bin/icloud_get_helper.dylib`。
   - Sign the binaries with `ldid2` using `akd.xml` / `ent.xml`, then strip them.  
     通过 `ldid2` 以 `akd.xml`/`ent.xml` 签名，并 strip 二进制。
   - Push artifacts via `sshpass/scp`, placing the executable at `/usr/bin/icloud_get_helper` and the dylib plus `txt/icloud_get_helper.plist` under `/Library/MobileSubstrate/DynamicLibraries/`.  
     通过 `sshpass`/`scp` 将可执行文件推送到 `/usr/bin/icloud_get_helper`，并把 dylib 与 `txt/icloud_get_helper.plist` 推送到 `/Library/MobileSubstrate/DynamicLibraries/`。

If you only need local binaries, temporarily comment out the `scp/ssh` segment or override `IPHONE_PASS` to block deployment.  
若只想在本地生成二进制，可临时注释 `scp/ssh` 段或覆盖 `IPHONE_PASS` 以阻止部署。

## Usage 运行与数据准备
### Generate auths_token 生成 auths_token
The iCloudGet and contacts/enroll APIs expect a plist that mirrors the system `akd` login cache; at minimum it should contain the following structure:  
`iCloudGet` 及通讯录/Enroll API 需要一个与系统 `akd` 登录缓存一致的 plist，最少需要如下结构：
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
  <key>Logins</key>
  <dict>
    <key>DsPrsId</key><string>8202854265</string>
    <key>t</key>
    <dict>
      <key>com.apple.gs.idms.pet</key>
      <dict><key>token</key><string>...</string></dict>
    </dict>
  </dict>
  <key>Tokens</key>
  <dict><key>mmeAuthToken</key><string>...</string></dict>
  <key>Signer</key>
  <dict>
    <key>X-Apple-I-MD</key><string>...</string>
    <key>X-Apple-I-MD-M</key><string>...</string>
    <key>X-Apple-I-MD-RINFO</key><string>...</string>
    <key>Device-UDID</key><string>...</string>
    <key>X-Mme-Device-Id</key><string>...</string>
    <key>X-Apple-I-Client-Time</key><string>...</string>
    <key>X-Apple-Locale</key><string>zh_CN</string>
    <key>X-Apple-I-Locale</key><string>zh_CN</string>
    <key>X-Apple-I-TimeZone</key><string>Asia/Shanghai</string>
  </dict>
</dict>
</plist>
```
You can collect it via a Substrate plugin (see `txt/icloud_get_helper.plist` for the `akd` target) or by running `frida/akd.js` to observe `AKAppleIDAuthenticationController` callbacks, serialize the login response, and stash it under `/var/tmp/*.plist`.  
可通过 Substrate 插件（`txt/icloud_get_helper.plist` 指向的 `akd` 进程）或 `frida/akd.js` 监控 `AKAppleIDAuthenticationController` 回调，把登陆响应序列化成上述 plist 并保存到 `/var/tmp/*.plist`。

### CLI / Injection Flow CLI/注入流程
- **Standalone executable / 独立可执行文件** – After pushing `bin/icloud_get_helper` to the device, run it inside an `akd`/`root` shell to bootstrap AuthKit/CloudKit dependencies and inspect NSLog output (`log stream --process icloud_get_helper`).  
  将 `bin/icloud_get_helper` 推送到设备后，可在 `akd`/`root` shell 中直接运行以初始化 AuthKit/CloudKit 依赖，并通过 `log stream --process icloud_get_helper` 查看日志。
- **Substrate plugin / Substrate 插件** – `bin/icloud_get_helper.dylib` is injected into `akd` via `txt/icloud_get_helper.plist`; call any exported symbol from a constructor or companion tweak.  
  `bin/icloud_get_helper.dylib` 由 `txt/icloud_get_helper.plist` 控制注入 `akd`，可在 constructor 或其它 tweak 中调用导出接口。
- **Frida/LLDB** – In any process that links the necessary private frameworks, `dlopen("/usr/lib/icloud_get_helper.dylib")` and `dlsym` the functions as needed.  
  在包含相关私有 Framework 的进程里，可 `dlopen("/usr/lib/icloud_get_helper.dylib")` 后通过 `dlsym` 使用这些函数。

### Exported APIs 导出接口
| API | Notes (English) | 说明（中文） |
| --- | --- | --- |
| `bool iCloudGet(const char *auths_token_path, bool (*reset_cb)(NSMutableDictionary *))` | Orchestrates metadata/photos/backup downloads for the supplied account. Optional `reset_cb` lets you refresh credentials on HTTP failure. | 连续执行 CloudDocs / Photos / Backup 抓取流程，`auths_token_path` 指向上文的 plist，`reset_cb` 可选，用于在服务器返回 401 时刷新 token。返回值表示三段流程是否都成功。 |
| `NSMutableArray *BACKUP_ID_LIST(NSMutableDictionary *auths)` | Lists backup record identifiers stored under `com.apple.backupd`. | 返回 CloudKit 中 `com.apple.backupd` 记录里枚举到的设备备份 ID 列表。 |
| `const char *GetAvailableBackupLabel(NSMutableDictionary *auths)` | Calls the Cuttlefish/Octagon path (`fetchViableBottles`) and returns a base64-encoded string (static buffer). | 向 Cuttlefish `fetchViableBottles` 发起请求，用于检索 Octagon/escrow 信息，返回 base64 字符串指针（静态缓冲区）。 |
| `bool PCSIdentitySetup(NSDictionary *pcs_auths)` | Thin wrapper over `ProtectedCloudStorage`’s `PCSIdentitySetup` for establishing escrow identity. | 直接调用 `ProtectedCloudStorage` 中的 `PCSIdentitySetup`，将 `kPCSSetup*` 参数提交到 Escrow 服务。 |
| `NSString *FindCloudContacts(NSMutableDictionary *accountSettings, NSMutableDictionary *auths)` | Fetches contacts for the supplied MobileMe container using CardDAV `PROPFIND/REPORT`. | 使用 CardDAV `PROPFIND`/`REPORT` 获取联系人，`accountSettings` 来自 `https://setup.icloud.com/setup/get_account_settings` 或 `login_or_create` 响应。 |
| `bool ENROLL_DEVICE_REQUEST(NSMutableDictionary *auths, NSString *appleId, NSString *transactionUUID, NSData *escrowRecord)` | Replays the `SBDEnvironMent-v2` enroll call to build metadata, craft the club cert, and submit it to EscrowProxy. | 复现 `SBDEnvironMent-v2` Enroll 请求，生成 metadata、club cert 并提交 EscrowProxy。 |
| `void AppleAccountSignIn/SignOut(NSString *appleID, NSString *password)` | Automates sign-in/out through `AAUISignInFlowController` / `AKAppleIDAuthenticationController` inside AuthKit contexts. | 通过 `AAUISignInFlowController`/`AKAppleIDAuthenticationController` 自动登录/退出 Apple ID，适合在 `akd` 进程调试。 |

Example usage 示例：
```objective-c
NSMutableDictionary *tokens = ReadAuthsToken("/var/tmp/auths_token.plist");
BOOL ok = iCloudGet("/var/tmp/auths_token.plist", NULL);
NSMutableArray *backupIds = BACKUP_ID_LIST(tokens);
NSString *contactsXml = FindCloudContacts(accountSettings, tokens);
```
(`ReadAuthsToken` is an internal helper; parse the plist manually if you call these APIs from other processes.)  
（`ReadAuthsToken` 为源码内部 helper，如在其它进程调用可自行解析 plist。）

### Output & Debug 输出与调试
- CloudKit responses are printed via `NSLog`; monitor them with `log stream --process akd | grep icloud_get_helper`, or write `NSMutableArray` contents back to disk if needed.  
  CloudKit 返回体会通过 `NSLog` 打印，可使用 `log stream --process akd | grep icloud_get_helper` 观测，必要时也可在源码里把 `NSMutableArray contents` 写回沙盒。
- Network failures raise `CallAuthTokensForHTTPStatusCode`; implement `reset_cb` to refresh tokens on demand.  
  网络错误会触发 `CallAuthTokensForHTTPStatusCode`，若实现 `reset_cb` 可在此刷新 token。
- `txt/demo.py` replays signed URLs (`url + X-Apple-Object-ID + Range`) to verify that CloudKit download links remain valid on macOS.  
  `txt/demo.py` 演示如何使用 CloudKit 返回的 `url + X-Apple-Object-ID + Range` 请求实际数据块，可在 macOS 上运行验证签名 URL 是否有效。
- The Frida and Charles directories contain additional material for analyzing CloudKit/PCS protocols.  
  Frida 与 Charles 目录提供了进一步分析 CloudKit/PCS 协议的素材。

## Development Tips 进一步开发建议
- Keep the protobuf schemas in sync with Apple’s production descriptors by updating `proto_code/*.proto` and regenerating `proto_objc` whenever iOS/CloudKit versions change.  
  每次升级到新的 iOS/CloudKit 版本后，先更新 `proto_code/*.proto` 并重新生成 `proto_objc`，确保字段序号与服务器对齐。
- When linking from another process, copy the required private frameworks into `src/PrivateFrameworks/` and add the relevant `-framework Foo` entries under `FRAMEWORKS`.  
  如果需要在其他进程中链接，请确保对应私有 Framework 也已拷贝到 `src/PrivateFrameworks/` 并在 `FRAMEWORKS` 中添加 `-framework Foo`。
- Prototype new functionality in a Frida environment before migrating it into `icloud_get_helper.mm` or the dylib.  
  对于新的功能点，建议先在 Frida 环境下确认调用栈，再迁移到 `icloud_get_helper.mm` 或 dylib。
- Use the code responsibly and only against accounts you control—these experiments are strictly for legitimate security research.  
  所有实验仅用于安全研究，切勿在未授权账户或生产环境使用。
